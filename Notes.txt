2025.12.17 - 2.5h

Power management:
Gonna use Microchip MCP73871. It got full battery and power-path management, so I just gotta connect VBUS (USB-C) -> IN and OUT -> VDDH (nRF52840) + other 5V things.
AliExpress: https://www.aliexpress.com/item/1005008336731440.html
LSCS: https://www.lcsc.com/product-detail/C511310.html


TMR sensor:
Allegro CT8150PC-IS3/HS3 should work, but the specific placement relatively to the Gateron Double-Rail Magnetic switches is questinable. Has Â±8mT sensitivity range. ChatGPT suggests that the magnet should remain in the 2.5-5mm range from the sensor for it to work reliably, while the key travel is 4mm. It's especially likely that it will come too clode to the sensor. Will have to actually test this before making the PCB design.
Possile solutions include:
- Placing the sensor on the bottom of the PCB to prevent going over 8mT when the key is fully pressed. Could cut off the sensing at the top.
- Make the firmware show the switch as fully pressed at ~90% actually pressed. Cuts off the analog functionality at the bottom.
- Place the sensor a bit off center. Weakens the magnetic field, improves linearity (ChatGPT claim), wouldn't matter much to the sensitivity, because it's TMR.
Turns out they're really expensive. Found them only at LCSC (https://www.lcsc.com/product-detail/C22879138.html) for ~1.5$/pcs. Will try to find something cheaper.


For multiplexing nRF's SAADC pins:
Texas Instruments CD4051B is suitable, although has sort of high resistance. Esch of them has 8 inputs, so I'm gonna need 9 of them.
Could be connected like this:
3 MUSx per one ADC pin
All MUXs share the address pins (3)
3 MUXs have their enable pins connected together.

So:
ADC: SAADC1, EN1
ADC: SAADC1, EN2
ADC: SAADC1, EN3

ADC: SAADC2, EN1
ADC: SAADC2, EN2
ADC: SAADC2, EN3

ADC: SAADC3, EN1
ADC: SAADC3, EN2
ADC: SAADC3, EN3

That way nRF can read every sensor independently.

Will go with SOP-16 package for easier assembly.

Cheapest at LCSC: https://www.lcsc.com/product-detail/C87646.html
AliExpress: https://www.aliexpress.com/item/1005009321962080.html



2025.12.18 - 2h:


There are no cheaper analog sensors :(


Li-Po battery - basically Li-Ion, but in any shape.


Using adaptive polling rate (event-driven scanning, no movement for a while = 50Hz, movement = more Hz) saves battery.


nRF52840 in modules, cuz gonna have to buy 5 of them anyway - plenty of everything.

Series resistor (10 Ohms) on SDA and SCL to limit inrush current on plug/unplug.
Pull-ups only on the main module.
MOSFETs, that block SDA and SCL until the slave MCU powers up completely and opens them.

Thin SDA and SCL (.15-.2mm) ans no parralel power/GND.

When connected, the slave module sets a "discovery" address, which the main MCU will periodically look for. When there is one, the main MCU will ask for module type and then assign a unique address for current session. The slaves will have to keep the next slaves in line without power, until they receive their session address so there's no multiple MCUs with the same address.



2025.12.20 - 2.5h:


Decided to add SPI buses for higher-speed modules (displays and trackpads).
Will need to do SCLK, MOSI, MISO and 2-3 CS pins for each bus. Multiple CSs are to allow connecting multiple SPI modules on the same bus (same side of the keyboard).
SPIs are kinda sensitive, so need a lot of precautions. By default the SCLK, MOSI, MISO and CS should be isolated until the slave is powered up and ready to estabilish the connection.

1. The module is connected, MCU powers up, all buses are isolated.
2. The slave opens I2C, goes live on it and tells the master, that it it's and SPI module.
3. The master tells the slave to open the SPI and start communication.
4. It works!

All CS lines should have pull-ups (10-100 kOhms) on the master side. Good to add pull-downs on clock lines. 22-68 Ohm series resistors on SCLK amd MOSI close to the master MCU


Decided to use SN74CBTLV3384 for I2C and SPI isolation. It can enable it's channels in groups of 5, so I can keep SPI switched off even when I2C is active.

Cheapest at LCSC: https://www.lcsc.com/product-detail/C2653297.html
DigiKey: https://www.digikey.ee/en/products/detail/texas-instruments/SN74CBTLV3384PWR/378134


Pogo pins. Hybrid connectors on each side (half pins are pins, half are pads), so the module can be connected anywhere.
